<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Gallery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/fb.css" type="text/css" />
  <link rel="stylesheet" href="/css/style.css" type="text/css" />
   <style>
        .fancybox-button--thumbs {display: none;}
        .fancybox-button--play {display: none;}
        .fancybox-button--close {display: none;}
        .masonry-item img { display: block; max-width: 100%; height: auto; }
    </style> 
    <script src="/bundled"></script>
</head>

<body>
    <button class="sidebar-toggle-btn" onclick="document.querySelector('.sidebar').classList.toggle('open')">‚ò∞</button>
    <button class="scroll-to-top-btn" onclick="scrollToTopAndReset()">‚¨ÜÔ∏è Reset</button>
    <div class="sidebar">
        <div class="sidebar-header"></div>
        <div id="folder-tree-container"></div>
    </div>

    <div class="gallery-container">
        <div id="gallery" class="masonry" style="overflow: hidden">
            <div class="grid-sizer"></div>
        </div>
        <div id="loading" class="loading">Loading...</div>
    </div>

    <script>
(function(){const VIDEO_VOLUME=0.3;const urlParams=new URLSearchParams(window.location.search);const dir=urlParams.get("dir")||"";let page=1;let hasMore=true,isLoading=false,initialLoad=true;let masonryInstance,debounceTimer,observer;let itemObserver=null;const $gallery=$("#gallery");const $loading=$("#loading");function initializeMasonry(){masonryInstance=new Masonry($gallery[0],{itemSelector:".masonry-item",percentPosition:true,columnWidth:".grid-sizer",gutter:0,transitionDuration:0});}
let layoutScheduled=false;function debounceLayout(){if(layoutScheduled)return;layoutScheduled=true;requestAnimationFrame(function(){if(masonryInstance)masonryInstance.layout();layoutScheduled=false;});}
function setupLazyObserver(selector,loadFn,rootMargin){const io=new IntersectionObserver((entries,obs)=>{for(const entry of entries){if(entry.isIntersecting){try{const shouldUnobserve=loadFn(entry.target);if(shouldUnobserve)obs.unobserve(entry.target);}catch(e){console.error('Lazy load handler failed',e);obs.unobserve(entry.target);}}}},{rootMargin});document.querySelectorAll(`${selector}:not([data-observed])`).forEach(el=>{io.observe(el);el.dataset.observed="true";});}
function lazyLoadImages(){setupLazyObserver("img.thumb-img",img=>{const small=img.getAttribute("data-thumb-small");const large=img.getAttribute("data-thumb-large");if(!small)return false;const cur=img.getAttribute('src')||'';if(cur.includes('base64')||cur.includes('placeholder')||cur===''){img.src=small;}
const onLoad=function(){debounceLayout();if(!large){img.removeEventListener('load',onLoad);return;}
const pre=new Image();pre.onload=()=>{img.src=large;debounceLayout();};pre.src=large;img.removeEventListener('load',onLoad);};img.addEventListener('load',onLoad,{once:true});return true;},"800px");}
function lazyLoadVideos(){setupLazyObserver("video.lazy-video",video=>{const source=video.querySelector("source");if(!source)return false;const srcVal=source.dataset.src||source.getAttribute('data-src');if(!srcVal)return false;source.src=srcVal;video.load();video.volume=VIDEO_VOLUME;video.addEventListener("loadedmetadata",debounceLayout,{once:true});return true;},"500px");}
function initInfiniteScroll(){const loadingEl=document.getElementById("loading");if(!loadingEl)return;if(observer)observer.disconnect();observer=new IntersectionObserver(entries=>{const ent=entries&&entries[0];if(!ent)return;console.log('InfiniteScroll: loading sentinel intersect',{isIntersecting:ent.isIntersecting,hasMore,isLoading});if(ent.isIntersecting&&hasMore&&!isLoading)loadMedia(true);},{rootMargin:"600px"});observer.observe(loadingEl);observeLastItem();}
function observeLastItem(){if(itemObserver){try{itemObserver.disconnect();}catch(e){}
itemObserver=null;}
const items=document.querySelectorAll('#gallery .masonry-item');if(!items||items.length===0)return;const last=items[items.length-1];itemObserver=new IntersectionObserver(entries=>{const e=entries&&entries[0];if(!e)return;console.log('ItemObserver: last item intersect',{isIntersecting:e.isIntersecting,hasMore,isLoading});if(e.isIntersecting&&hasMore&&!isLoading)loadMedia(false);},{rootMargin:'400px'});itemObserver.observe(last);}
function handleThumbnailStatus(item,element){if(item.type!=='image'&&item.type!=='video')return;const img=element.querySelector('img.thumb-img');if(!img)return;let small=item.thumb_small;let large=item.thumb_large;let statusSmall=(typeof item.thumb_small_status!=='undefined')?item.thumb_small_status:undefined;if(!small&&item.thumb){const m=item.thumb.match(/^(.*)\.([a-zA-Z0-9]+)$/);if(m){const base=m[1];const ext=m[2];if(base.endsWith('-small')){small=base+'.'+ext;large=base.slice(0,-6)+'-large.'+ext;}else if(base.endsWith('-large')){large=base+'.'+ext;small=base.slice(0,-6)+'-small.'+ext;}else{small=base+'-small.'+ext;large=base+'-large.'+ext;}}else{small=item.thumb;large=item.thumb;}
if(typeof statusSmall==='undefined'&&typeof item.thumbStatus!=='undefined')statusSmall=item.thumbStatus;const prefix=(dir&&dir.length)?`/images/${dir}/thumbs/`:'/images/thumbs/';if(small&&!small.startsWith('/')&&(!small.includes('/')||small.startsWith('thumbs/'))){small=small.replace(/^thumbs\//,'');small=prefix+small;}
if(large&&!large.startsWith('/')&&(!large.includes('/')||large.startsWith('thumbs/'))){large=large.replace(/^thumbs\//,'');large=prefix+large;}}
if(!small)return;if(statusSmall===1){img.setAttribute('data-thumb-small',small);if(large)img.setAttribute('data-thumb-large',large);const cur=img.getAttribute('src')||'';if(cur===''||cur.includes('placeholder')||cur.includes('base64'))img.src=small;}else{img.src='/images/placeholder.jpg';const checker=setInterval(()=>{const probe=new Image();probe.onload=()=>{img.src=small+'?t='+Date.now();img.setAttribute('data-thumb-small',small);if(large)img.setAttribute('data-thumb-large',large);debounceLayout();clearInterval(checker);};probe.onerror=()=>{};probe.src=small+'?t='+Date.now();},3000);}}
function loadMedia(){if(!hasMore||isLoading)return;isLoading=true;$loading.text("Loading...").show();console.log('Requesting /api/media',{dir:dir,page:page});$.get(`/api/media?dir=${encodeURIComponent(dir)}&page=${page}&render=html`,html=>{try{const container=document.createElement('div');container.innerHTML=html;const frag=container.querySelector('.masonry-fragment');if(!frag){console.warn('No masonry fragment returned from server');return;}
const returnedPage=parseInt(frag.getAttribute('data-page'))||page;const returnedHasMore=frag.getAttribute('data-hasmore')==='1';const nodes=Array.from(frag.children);if(nodes.length){const docFrag=document.createDocumentFragment();nodes.forEach(n=>docFrag.appendChild(n));if(!masonryInstance)initializeMasonry();$gallery.append(docFrag);masonryInstance.appended(nodes);if(typeof imagesLoaded==='function'){imagesLoaded($gallery[0],()=>{masonryInstance.layout();observeLastItem();});}else{setTimeout(()=>{masonryInstance.layout();observeLastItem();},100);}
lazyLoadImages();lazyLoadVideos();initFancybox();}
hasMore=returnedHasMore;try{if(nodes.length>0){}}catch(e){console.warn('Failed to handle loaded fragment',e);}
if(initialLoad)initInfiniteScroll();page++;$loading.text(hasMore?"Loading...":"No more media");initialLoad=false;}catch(ex){console.error('Error handling server fragment',ex);}}).fail((xhr,status,err)=>{console.error('Failed to load server-rendered media',status,err);}).always(()=>{isLoading=false;if(!hasMore)$loading.hide();});}
window.scrollToTopAndReset=function(){window.scrollTo({top:0,behavior:"smooth"});masonryInstance&&masonryInstance.destroy()
$gallery.empty().append('<div class="grid-sizer"></div>');initializeMasonry();page=1;hasMore=true;isLoading=false;initInfiniteScroll();loadMedia();};function updateResetButtonVisibility(){const btn=document.querySelector(".scroll-to-top-btn");if(!btn)return;if((page||1)>1){btn.classList.remove("hidden");}else{btn.classList.add("hidden");}}
function initFancybox(){$('[data-fancybox="gallery"]').fancybox({buttons:["close"],loop:true,video:{autoplay:false,preload:"none",controls:false,loop:true},afterShow:(_,current)=>{masonryInstance.layout();const video=current.$content.find("video").get(0);if(video){const source=video.querySelector('source');if(source&&!source.src){source.src=source.dataset.src||source.getAttribute('data-src')||source.src;}
Object.assign(video,{controls:true,preload:"metadata",volume:VIDEO_VOLUME,muted:false,loop:true});video.load();}},afterClose:(_,current)=>{const video=current.$content.find("video").get(0);if(video){video.pause();video.currentTime=0;}}});}
(function folderTree(){const activeDir=urlParams.get("dir")||"";function buildTree(node){if(!node||!node.children)return""
return`<ul class="folder-list">`+node.children.map(child=>{const isActive=activeDir===child.path;const hasChildren=child.children&&child.children.length>0
const isOpen=isActive||activeDir.startsWith(child.path+"/");return`<li class="folder-item ${hasChildren ? "has-children" : ""} ${isOpen ? "open" : ""}" data-path="${child.path}">${hasChildren ? '<span class="folder-toggle"></span>' : '<span class="folder-spacer"></span>'}<a href="/?dir=${child.path}" class="folder-link ${isActive ? "active" : ""}">üìÅ<span class="folder-name">${child.name}</span></a>${hasChildren ? `<div class="folder-children"style="display:${isOpen ? "block" : "none"};">${buildTree(child)}</div>` : ""}</li>`;}).join("")+`</ul>`;}
function initFolderToggles(){document.querySelectorAll(".folder-item.has-children").forEach(item=>{const toggle=item.querySelector(".folder-toggle");const children=item.querySelector(".folder-children");const toggleOpen=()=>{item.classList.toggle("open");children.style.display=item.classList.contains("open")?"block":"none";debounceLayout();};toggle.addEventListener("click",e=>{e.stopPropagation();toggleOpen();});item.querySelector(".folder-link")?.addEventListener("click",toggleOpen);});}
document.addEventListener("DOMContentLoaded",()=>{fetch("/api/tree").then(r=>r.ok?r.json():Promise.reject(r.status)).then(data=>{const container=document.getElementById("folder-tree-container");if(!data)return container.innerHTML="<p>No media folders found.</p>";container.innerHTML=buildTree(data);initFolderToggles();const activeItem=document.querySelector(`.folder-item[data-path="${activeDir}"]`);if(activeItem){let el=activeItem;while(el&&el.classList&&el.classList.contains("folder-item")){el.classList.add("open");const children=el.querySelector(".folder-children");if(children)children.style.display="block";el=el.parentElement?el.parentElement.closest(".folder-item"):null;}
setTimeout(()=>activeItem.scrollIntoView({block:"center",behavior:"smooth"}),300);}}).catch(()=>{document.getElementById("folder-tree-container").innerHTML="<p>Error loading folders.</p>";});});})();(function uiHandlers(){const btn=document.querySelector(".scroll-to-top-btn");const originalPush=history.pushState;history.pushState=function(...args){originalPush.apply(this,args);updateResetButtonVisibility();};const originalReplace=history.replaceState;history.replaceState=function(...args){originalReplace.apply(this,args);updateResetButtonVisibility();};window.addEventListener("popstate",updateResetButtonVisibility);document.addEventListener("DOMContentLoaded",()=>{updateResetButtonVisibility();if(window.innerWidth>768&&localStorage.getItem("sidebarState")==="open"){document.querySelector(".sidebar")?.classList.add("open");}});let _scrollTimer=null;function checkNearBottom(){if(_scrollTimer)return;_scrollTimer=setTimeout(()=>{_scrollTimer=null;if(btn)btn.classList.toggle("show",window.scrollY>200);const nearBottom=(window.innerHeight+window.scrollY)>=(document.documentElement.scrollHeight-240);if(nearBottom){console.log('Scroll check: near bottom',{page,hasMore,isLoading});if(hasMore&&!isLoading)loadMedia();}},150);}
window.addEventListener("scroll",checkNearBottom);window.onbeforeunload=()=>window.scrollTo(0,0);document.addEventListener("click",e=>{if(window.innerWidth<=768&&!e.target.closest(".sidebar")&&!e.target.matches(".sidebar-toggle-btn")){document.querySelector(".sidebar")?.classList.remove("open");}});document.addEventListener("keydown",e=>{if(e.key==="Escape")document.querySelector(".sidebar")?.classList.remove("open");});document.addEventListener("play",e=>{if(e.target.tagName==="VIDEO"){Object.assign(e.target,{volume:VIDEO_VOLUME,muted:false,loop:true});}},true);})();$(document).ready(()=>{initFancybox();initializeMasonry();initInfiniteScroll();loadMedia();});window.u=loadMedia;})();
    </script>
    
</body>

</html>