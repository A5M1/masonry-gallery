<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Gallery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/fb.css" type="text/css" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" />
    <script src="/bundled"></script>
</head>

<body>
    <button class="sidebar-toggle-btn" onclick="document.querySelector('.sidebar').classList.toggle('open')">‚ò∞</button>
   <!--<button class="scroll-to-top-btn" onclick="scrollToTopAndReset()">‚¨ÜÔ∏è Reset</button>--> 
    <div class="sidebar">
        <div class="sidebar-header"></div>
        <div id="folder-tree-container"></div>
    </div>

    <div class="gallery-container">
        <div id="gallery" class="masonry" style="overflow: hidden">
            <div class="grid-sizer"></div>
        </div>
        <div id="loading" class="loading">Loading...</div>
    </div>

    <script>
!function(){const e=.3,t=new URLSearchParams(window.location.search),o=t.get("dir")||"";let n,r,s=1,a=!0,i=!1,c=!0,l=null;const d=$("#gallery"),u=$("#loading");function m(){n=new Masonry(d[0],{itemSelector:".masonry-item",percentPosition:!0,columnWidth:".grid-sizer",gutter:0,transitionDuration:0})}let g=!1;function p(){g||(g=!0,requestAnimationFrame((function(){n&&n.layout(),g=!1})))}function h(e,t,o){const n=new IntersectionObserver(((e,o)=>{for(const n of e)if(n.isIntersecting)try{t(n.target)&&o.unobserve(n.target)}catch(e){console.error("Lazy load handler failed",e),o.unobserve(n.target)}}),{rootMargin:o});document.querySelectorAll(`${e}:not([data-observed])`).forEach((e=>{n.observe(e),e.dataset.observed="true"}))}function f(){const e=document.getElementById("loading");e&&(r&&r.disconnect(),r=new IntersectionObserver((e=>{const t=e&&e[0];t&&(console.log("InfiniteScroll: loading sentinel intersect",{isIntersecting:t.isIntersecting,hasMore:a,isLoading:i}),t.isIntersecting&&a&&!i&&v())}),{rootMargin:"600px"}),r.observe(e),y())}function y(){if(l){try{l.disconnect()}catch(e){}l=null}const e=document.querySelectorAll("#gallery .masonry-item");if(!e||0===e.length)return;const t=e[e.length-1];l=new IntersectionObserver((e=>{const t=e&&e[0];t&&(console.log("ItemObserver: last item intersect",{isIntersecting:t.isIntersecting,hasMore:a,isLoading:i}),t.isIntersecting&&a&&!i&&v())}),{rootMargin:"400px"}),l.observe(t)}function v(){a&&!i&&(i=!0,u.text("Loading...").show(),console.log("Requesting /api/media",{dir:o,page:s}),$.get(`/api/media?dir=${encodeURIComponent(o)}&page=${s}&render=html`,(t=>{try{const o=document.createElement("div");o.innerHTML=t;const r=o.querySelector(".masonry-fragment");if(!r)return void console.warn("No masonry fragment returned from server");parseInt(r.getAttribute("data-page"));const i="1"===r.getAttribute("data-hasmore"),l=Array.from(r.children);if(l.length){const t=document.createDocumentFragment();l.forEach((e=>t.appendChild(e))),n||m(),d.append(t),n.appended(l),"function"==typeof imagesLoaded?imagesLoaded(d[0],(()=>{n.layout(),y()})):setTimeout((()=>{n.layout(),y()}),100),h("img.thumb-img",(e=>{const t=e.getAttribute("data-thumb-small"),o=e.getAttribute("data-thumb-large");if(!t)return!1;const n=e.getAttribute("src")||"";(n.includes("base64")||n.includes("placeholder")||""===n)&&(e.src=t);const r=function(){if(p(),!o)return void e.removeEventListener("load",r);const t=new Image;t.onload=()=>{e.src=o,p()},t.src=o,e.removeEventListener("load",r)};return e.addEventListener("load",r,{once:!0}),!0}),"800px"),h("video.lazy-video",(t=>{const o=t.querySelector("source");if(!o)return!1;const n=o.dataset.src||o.getAttribute("data-src");return!!n&&(o.src=n,t.load(),t.volume=e,t.addEventListener("loadedmetadata",p,{once:!0}),!0)}),"500px"),w()}a=i;try{l.length}catch(e){console.warn("Failed to handle loaded fragment",e)}c&&f(),s++,u.text(a?"Loading...":"No more media"),c=!1}catch(e){console.error("Error handling server fragment",e)}})).fail(((e,t,o)=>{console.error("Failed to load server-rendered media",t,o)})).always((()=>{i=!1,a||u.hide()})))}function b(){const e=document.querySelector(".scroll-to-top-btn");e&&((s||1)>1?e.classList.remove("hidden"):e.classList.add("hidden"))}function w(){$('[data-fancybox="gallery"]').fancybox({buttons:["close"],loop:!0,video:{autoplay:!1,preload:"none",controls:!1,loop:!0},afterShow:(t,o)=>{n.layout();const r=o.$content.find("video").get(0);if(r){const t=r.querySelector("source");t&&!t.src&&(t.src=t.dataset.src||t.getAttribute("data-src")||t.src),Object.assign(r,{controls:!0,preload:"metadata",volume:e,muted:!1,loop:!0}),r.load()}},afterClose:(e,t)=>{const o=t.$content.find("video").get(0);o&&(o.pause(),o.currentTime=0)}})}window.scrollToTopAndReset=function(){window.scrollTo({top:0,behavior:"smooth"}),n&&n.destroy(),d.empty().append('<div class="grid-sizer"></div>'),m(),s=1,a=!0,i=!1,f(),v()},function(){const e=t.get("dir")||"";function o(t){return t&&t.children?'<ul class="folder-list">'+t.children.map((t=>{const n=e===t.path,r=t.children&&t.children.length>0,s=n||e.startsWith(t.path+"/");return`<li class="folder-item ${r?"has-children":""} ${s?"open":""}" data-path="${t.path}">${r?'<span class="folder-toggle"></span>':'<span class="folder-spacer"></span>'}<a href="/?dir=${t.path}" class="folder-link ${n?"active":""}">üìÅ<span class="folder-name">${t.name}</span></a>${r?`<div class="folder-children"style="display:${s?"block":"none"};">${o(t)}</div>`:""}</li>`})).join("")+"</ul>":""}document.addEventListener("DOMContentLoaded",(()=>{fetch("/api/tree").then((e=>e.ok?e.json():Promise.reject(e.status))).then((t=>{const n=document.getElementById("folder-tree-container");if(!t)return n.innerHTML="<p>No media folders found.</p>";n.innerHTML=o(t),document.querySelectorAll(".folder-item.has-children").forEach((e=>{const t=e.querySelector(".folder-toggle"),o=e.querySelector(".folder-children"),n=()=>{e.classList.toggle("open"),o.style.display=e.classList.contains("open")?"block":"none",p()};t.addEventListener("click",(e=>{e.stopPropagation(),n()})),e.querySelector(".folder-link")?.addEventListener("click",n)}));const r=document.querySelector(`.folder-item[data-path="${e}"]`);if(r){let e=r;for(;e&&e.classList&&e.classList.contains("folder-item");){e.classList.add("open");const t=e.querySelector(".folder-children");t&&(t.style.display="block"),e=e.parentElement?e.parentElement.closest(".folder-item"):null}setTimeout((()=>r.scrollIntoView({block:"center",behavior:"smooth"})),300)}})).catch((()=>{document.getElementById("folder-tree-container").innerHTML="<p>Error loading folders.</p>"}))}))}(),function(){const t=document.querySelector(".scroll-to-top-btn"),o=history.pushState;history.pushState=function(...e){o.apply(this,e),b()};const n=history.replaceState;history.replaceState=function(...e){n.apply(this,e),b()},window.addEventListener("popstate",b),document.addEventListener("DOMContentLoaded",(()=>{b(),window.innerWidth>768&&"open"===localStorage.getItem("sidebarState")&&document.querySelector(".sidebar")?.classList.add("open")}));let r=null;window.addEventListener("scroll",(function(){r||(r=setTimeout((()=>{r=null,t&&t.classList.toggle("show",window.scrollY>200);window.innerHeight+window.scrollY>=document.documentElement.scrollHeight-240&&(console.log("Scroll check: near bottom",{page:s,hasMore:a,isLoading:i}),a&&!i&&v())}),150))})),window.onbeforeunload=()=>window.scrollTo(0,0),document.addEventListener("click",(e=>{window.innerWidth<=768&&!e.target.closest(".sidebar")&&!e.target.matches(".sidebar-toggle-btn")&&document.querySelector(".sidebar")?.classList.remove("open")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector(".sidebar")?.classList.remove("open")})),document.addEventListener("play",(t=>{"VIDEO"===t.target.tagName&&Object.assign(t.target,{volume:e,muted:!1,loop:!0})}),!0)}(),$(document).ready((()=>{w(),m(),f(),v()})),window.u=v}();
    </script>
    
</body>

</html>